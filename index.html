<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="zalo-platform-site-verification" content="ITkmAutGOI48yj4rq_jw0L7ky1ozc2TBCpKu" />
  <title>Zalo 登录授权</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    .container {
      text-align: center;
      color: white;
    }
    .loading {
      font-size: 18px;
      margin-top: 20px;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error {
      background: white;
      color: #e74c3c;
      padding: 20px;
      border-radius: 8px;
      margin: 20px;
      max-width: 400px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div>正在处理 Zalo 登录授权...</div>
    </div>
    <div id="error" class="error" style="display: none;"></div>
  </div>

  <script>
    // 获取 URL 参数
    function getUrlParams() {
      const params = new URLSearchParams(window.location.search);
      return {
        app_id: params.get('app_id'),
        app_secret: params.get('app_secret'),
        redirect_uri: params.get('redirect_uri'),
        platform: params.get('platform') || 'web',
        use_postmessage: params.get('use_postmessage') === 'true',
        // 授权回调参数
        code: params.get('code'),
        state: params.get('state'),
        error: params.get('error')
      };
    }

    // 生成随机字符串
    function generateRandomString(length) {
      let text = '';
      const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
      for (let i = 0; i < length; i++) {
        text += possible.charAt(Math.floor(Math.random() * possible.length));
      }
      return text;
    }

    // Base64 URL 编码
    function base64URL(string) {
      return string
        .toString(CryptoJS.enc.Base64)
        .replace(/=/g, '')
        .replace(/\+/g, '-')
        .replace(/\//g, '_');
    }

    // 生成 code_verifier 和 code_challenge
    function generateCodeChallenge() {
      const code_verifier = generateRandomString(16);
      const code_challenge = base64URL(CryptoJS.SHA256(code_verifier));
      return {
        code_verifier,
        code_challenge
      };
    }

    // 显示错误
    function showError(message) {
      const loadingEl = document.getElementById('loading');
      const errorEl = document.getElementById('error');
      if (loadingEl) loadingEl.style.display = 'none';
      if (errorEl) {
        errorEl.style.display = 'block';
        errorEl.textContent = message || '发生错误，请重试';
      }
    }

    // 发送消息给父窗口（支持Web和Flutter-web两种格式）
    function sendMessageToParent(type, data) {
      if (window.opener && !window.opener.closed) {
        try {
          // 检测是否为Flutter-web调用（优先从sessionStorage读取，因为回调时URL参数可能不同）
          const usePostMessage = sessionStorage.getItem('zalo_use_postmessage') === 'true';
          const platform = sessionStorage.getItem('zalo_platform') || 'web';
          const isFlutterWeb = usePostMessage || platform === 'flutter-web';
          const isSuccess = type === 'ZALO_LOGIN_SUCCESS';
          
          if (isFlutterWeb) {
            // Flutter-web格式
            if (isSuccess) {
              // 成功：发送Flutter-web格式
              const flutterResult = {
                type: 'zalo_auth_result',
                success: true,
                data: {
                  access_token: data.access_token,
                  user_id: data.userInfo?.id?.toString() || '',
                  expires_in: data.tokenResponse?.expires_in || null,
                  refresh_token: data.tokenResponse?.refresh_token || null,
                  user_info: data.userInfo ? {
                    id: data.userInfo.id,
                    name: data.userInfo.name || null,
                    birthday: data.userInfo.birthday || null,
                    gender: data.userInfo.gender || null,
                    picture: data.userInfo.picture?.data?.url || data.userInfo.picture || null
                  } : null
                },
                timestamp: Date.now()
              };
              
              window.opener.postMessage(flutterResult, '*');
              console.log('已发送Flutter-web成功消息');
            } else {
              // 失败：发送Flutter-web格式
              const errorData = data.error || data.error_description || '未知错误';
              const flutterResult = {
                type: 'zalo_auth_result',
                success: false,
                data: {
                  error: typeof errorData === 'string' ? errorData : (errorData?.message || '未知错误'),
                  error_code: data.error_code || data.tokenResponse?.error || null,
                  error_details: data.error_details || data.tokenResponse?.error_description || null
                },
                timestamp: Date.now()
              };
              
              window.opener.postMessage(flutterResult, '*');
              console.log('已发送Flutter-web错误消息');
            }
          } else {
            // Web格式（原有格式）
            window.opener.postMessage({
              type: type,
              ...data
            }, '*');
            console.log('已发送Web格式消息:', type);
          }
        } catch (error) {
          console.error('发送消息失败:', error);
          // 如果发送失败，尝试使用原始格式
          try {
            window.opener.postMessage({
              type: type,
              ...data
            }, '*');
          } catch (e) {
            console.error('发送消息完全失败:', e);
          }
        }
      }
    }

    // 获取 Zalo Access Token
    async function getZaloAccessToken(code, app_id, app_secret, code_verifier) {
      const params = new URLSearchParams({
        code: code,
        app_id: app_id,
        grant_type: 'authorization_code',
        code_verifier: code_verifier
      });

      try {
        const response = await fetch('https://oauth.zaloapp.com/v4/access_token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'secret_key': app_secret
          },
          body: params.toString()
        });

        const data = await response.json();
        return data;
      } catch (error) {
        console.error('获取 access_token 失败:', error);
        throw error;
      }
    }

    // 获取 Zalo 用户信息
    async function getZaloInfo(access_token, app_secret) {
      try {
        const response = await fetch(
          `https://graph.zalo.me/v2.0/me?fields=id,birthday,gender,picture,name&access_token=${access_token}`,
          {
            method: 'GET',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'secret_key': app_secret,
              'access_token': access_token
            }
          }
        );

        const data = await response.json();
        return data;
      } catch (error) {
        console.error('获取用户信息失败:', error);
        throw error;
      }
    }

    // 处理授权回调
    async function handleCallback(params) {
      const { code, state, error } = params;

      // 从 sessionStorage 获取保存的参数
      const app_id = sessionStorage.getItem('zalo_app_id');
      const app_secret = sessionStorage.getItem('zalo_app_secret');

      if (error) {
        showError('授权失败: ' + error);
        sendMessageToParent('ZALO_LOGIN_ERROR', { 
          error: error,
          error_code: error
        });
        // 清理 sessionStorage
        sessionStorage.removeItem('zalo_app_id');
        sessionStorage.removeItem('zalo_app_secret');
        sessionStorage.removeItem('zalo_code_verifier');
        sessionStorage.removeItem('zalo_platform');
        sessionStorage.removeItem('zalo_use_postmessage');
        setTimeout(() => {
          window.close();
        }, 2000);
        return;
      }

      if (!code || !state) {
        showError('缺少必要的授权参数');
        sendMessageToParent('ZALO_LOGIN_ERROR', { 
          error: 'missing_params',
          error_code: 'missing_params'
        });
        // 清理 sessionStorage
        sessionStorage.removeItem('zalo_app_id');
        sessionStorage.removeItem('zalo_app_secret');
        sessionStorage.removeItem('zalo_code_verifier');
        sessionStorage.removeItem('zalo_platform');
        sessionStorage.removeItem('zalo_use_postmessage');
        setTimeout(() => {
          window.close();
        }, 2000);
        return;
      }

      if (!app_id || !app_secret) {
        showError('缺少必要的配置参数（app_id 或 app_secret）');
        sendMessageToParent('ZALO_LOGIN_ERROR', { 
          error: 'missing_config',
          error_code: 'missing_config'
        });
        setTimeout(() => {
          window.close();
        }, 2000);
        return;
      }

      // 从 state 中提取 code_verifier
      // state 格式: code_verifier-zalo_login
      const code_verifier = state.replace(/-zalo_login$/, '');
      
      if (!code_verifier) {
        showError('无效的 state 参数');
        sendMessageToParent('ZALO_LOGIN_ERROR', { 
          error: 'invalid_state',
          error_code: 'invalid_state'
        });
        // 清理 sessionStorage
        sessionStorage.removeItem('zalo_app_id');
        sessionStorage.removeItem('zalo_app_secret');
        sessionStorage.removeItem('zalo_code_verifier');
        sessionStorage.removeItem('zalo_platform');
        sessionStorage.removeItem('zalo_use_postmessage');
        setTimeout(() => {
          window.close();
        }, 2000);
        return;
      }

      try {
        // 获取 access_token
        const tokenResponse = await getZaloAccessToken(code, app_id, app_secret, code_verifier);
        
        if (tokenResponse.access_token) {
          // 获取用户信息
          let userInfo = null;
          try {
            userInfo = await getZaloInfo(tokenResponse.access_token, app_secret);
          } catch (err) {
            console.warn('获取用户信息失败，但继续流程:', err);
          }

          // 发送成功消息给父窗口
          sendMessageToParent('ZALO_LOGIN_SUCCESS', {
            code: code,
            zaloCodeVerifier: code_verifier,
            access_token: tokenResponse.access_token,
            userInfo: userInfo,
            tokenResponse: tokenResponse
          });

          // 显示成功消息
          const loadingEl = document.getElementById('loading');
          if (loadingEl) {
            loadingEl.innerHTML = '<div style="color: #2ecc71; font-size: 18px;">✓ 授权成功！窗口即将关闭...</div>';
          }

          // 清理 sessionStorage
          sessionStorage.removeItem('zalo_app_id');
          sessionStorage.removeItem('zalo_app_secret');
          sessionStorage.removeItem('zalo_code_verifier');

          // 延迟关闭窗口
          setTimeout(() => {
            window.close();
          }, 1000);
        } else {
          const errorMsg = tokenResponse.error_description || tokenResponse.error || '获取 access_token 失败';
          const errorCode = tokenResponse.error || 'token_exchange_failed';
          showError(errorMsg);
          sendMessageToParent('ZALO_LOGIN_ERROR', { 
            error: errorMsg,
            error_code: errorCode,
            error_details: tokenResponse.error_description,
            tokenResponse: tokenResponse
          });
          // 清理 sessionStorage
          sessionStorage.removeItem('zalo_app_id');
          sessionStorage.removeItem('zalo_app_secret');
          sessionStorage.removeItem('zalo_code_verifier');
          setTimeout(() => {
            window.close();
          }, 2000);
        }
      } catch (error) {
        console.error('处理授权回调失败:', error);
        const errorMsg = error.message || error.toString() || '未知错误';
        showError('处理授权失败: ' + errorMsg);
        sendMessageToParent('ZALO_LOGIN_ERROR', { 
          error: errorMsg,
          error_code: error.code || error.error || 'unknown_error',
          error_details: error.error_description || null
        });
        // 清理 sessionStorage
        sessionStorage.removeItem('zalo_app_id');
        sessionStorage.removeItem('zalo_app_secret');
        sessionStorage.removeItem('zalo_code_verifier');
        sessionStorage.removeItem('zalo_platform');
        sessionStorage.removeItem('zalo_use_postmessage');
        setTimeout(() => {
          window.close();
        }, 2000);
      }
    }

    // 初始化授权流程
    function initAuth(params) {
      const { app_id, app_secret, redirect_uri } = params;

      if (!app_id || !app_secret || !redirect_uri) {
        showError('缺少必要的参数: app_id、app_secret 和 redirect_uri 是必需的');
        // 如果是从Flutter-web调用，发送错误消息
        if (window.opener && !window.opener.closed) {
          sendMessageToParent('ZALO_LOGIN_ERROR', { 
            error: '缺少必要的参数: app_id、app_secret 和 redirect_uri 是必需的',
            error_code: 'missing_params'
          });
          setTimeout(() => {
            window.close();
          }, 2000);
        }
        return;
      }

      // 保存参数到 sessionStorage，以便回调时使用
      sessionStorage.setItem('zalo_app_id', app_id);
      sessionStorage.setItem('zalo_app_secret', app_secret);
      // 保存平台信息，以便回调时识别格式
      const params = getUrlParams();
      if (params.platform) {
        sessionStorage.setItem('zalo_platform', params.platform);
      }
      // 保存use_postmessage设置（如果URL中有该参数）
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('use_postmessage')) {
        sessionStorage.setItem('zalo_use_postmessage', params.use_postmessage === true ? 'true' : 'false');
      }

      // 生成 code_verifier 和 code_challenge
      const { code_verifier, code_challenge } = generateCodeChallenge();

      // 保存 code_verifier 到 sessionStorage，以便回调时使用
      sessionStorage.setItem('zalo_code_verifier', code_verifier);

      // 构建授权 URL
      const state = `${code_verifier}-zalo_login`;
      const authUrl = `https://oauth.zaloapp.com/v4/permission?app_id=${app_id}&redirect_uri=${encodeURIComponent(redirect_uri)}&code_challenge=${code_challenge}&state=${encodeURIComponent(state)}`;

      // 跳转到授权页面
      window.location.href = authUrl;
    }

    // 主函数
    function main() {
      const params = getUrlParams();

      // 检查是否是授权回调
      if (params.code || params.error) {
        // 这是回调页面，处理授权回调
        handleCallback(params);
      } else {
        // 初始化授权流程
        initAuth(params);
      }
    }

    // 页面加载完成后执行
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', main);
    } else {
      main();
    }
  </script>
</body>
</html>

