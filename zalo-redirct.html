<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>Zalo授权回调</title>
    <!-- 不加载任何外部脚本，只使用内联脚本（符合Zalo CSP策略） -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .message {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="message">
        <p>正在处理授权回调...</p>
    </div>
    <script>
        // 使用原生JavaScript，不依赖任何外部库（符合Zalo CSP策略）
        (function() {
            'use strict';
            
            // 解析URL参数
            function getUrlParams() {
                var params = {};
                var searchParams = window.location.search.substring(1).split('&');
                for (var i = 0; i < searchParams.length; i++) {
                    var pair = searchParams[i].split('=');
                    if (pair.length === 2) {
                        params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
                    }
                }
                return params;
            }
            
            var params = getUrlParams();
            var code = params.code;
            var state = params.state;
            var error = params.error || params.error_code;
            
            console.log('Zalo回调参数:', { code: code ? '已接收' : '无', state: state || '无', error: error || '无' });
            
            try {
                // 方案1：如果有父窗口（通过window.open打开），使用postMessage
                if (window.opener && !window.opener.closed) {
                    console.log('检测到父窗口，使用postMessage发送回调');
                    var currentUrl = window.location.href;
                    window.opener.postMessage({
                        type: 'zalo_auth_callback',
                        url: currentUrl,
                        code: code,
                        state: state,
                        error: error,
                        timestamp: Date.now()
                    }, '*'); // 注意：生产环境应指定具体origin
                    
                    // 延迟关闭窗口，确保消息已发送
                    setTimeout(function() {
                        if (window.opener && !window.opener.closed) {
                            window.close();
                        } else {
                            document.body.innerHTML = '<div class="message"><p>✅ 授权成功！窗口已关闭。</p></div>';
                        }
                    }, 200);
                } 
                // 方案2：如果没有父窗口（直接访问），重定向到index.html
                else {
                    console.log('未检测到父窗口，重定向到index.html处理回调');
                    // 将参数传递给index.html
                    var redirectUrl = window.location.origin + '/index.html?' + window.location.search.substring(1);
                    window.location.href = redirectUrl;
                }
            } catch (err) {
                console.error('Zalo回调处理错误:', err);
                // 如果postMessage失败，尝试重定向到index.html
                try {
                    var redirectUrl = window.location.origin + '/index.html?' + window.location.search.substring(1);
                    window.location.href = redirectUrl;
                } catch (redirectErr) {
                    document.body.innerHTML = '<div class="message"><p style="color: #ff6b6b;">❌ 处理失败，请手动关闭窗口。</p></div>';
                }
            }
        })();
    </script>
</body>
</html>