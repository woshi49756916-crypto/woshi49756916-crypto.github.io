<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>Zalo授权回调</title>
    <!-- 不加载任何外部脚本，只使用内联脚本（符合Zalo CSP策略） -->
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .message {
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="message">
        <p>正在处理授权回调...</p>
    </div>
    <script>
        // 使用原生JavaScript，不依赖任何外部库（符合Zalo CSP策略）
        (function() {
            'use strict';
            
            // 解析URL参数
            function getUrlParams() {
                var params = {};
                var searchParams = window.location.search.substring(1).split('&');
                for (var i = 0; i < searchParams.length; i++) {
                    var pair = searchParams[i].split('=');
                    if (pair.length === 2) {
                        params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1]);
                    }
                }
                return params;
            }
            
            var params = getUrlParams();
            var code = params.code;
            var state = params.state;
            var error = params.error || params.error_code;
            
            console.log('Zalo回调参数:', { code: code ? '已接收' : '无', state: state || '无', error: error || '无' });
            
            try {
                // 方案1：如果有父窗口，尝试通过postMessage发送回调
                // 注意：由于index.html在弹窗内跳转到Zalo，Zalo重定向回来时，window.opener可能仍然存在
                // 如果window.opener是index.html，它会处理消息；如果是Flutter，它会忽略，然后我们重定向到index.html
                if (window.opener && !window.opener.closed) {
                    console.log('检测到父窗口，尝试发送postMessage');
                    var currentUrl = window.location.href;
                    
                    try {
                        // 尝试发送消息给父窗口（可能是index.html或Flutter）
                        window.opener.postMessage({
                            type: 'zalo_auth_callback',
                            url: currentUrl,
                            code: code,
                            state: state,
                            error: error,
                            timestamp: Date.now()
                        }, '*'); // 注意：生产环境应指定具体origin
                        
                        console.log('postMessage已发送，等待父窗口处理...');
                    } catch (postErr) {
                        console.warn('postMessage发送失败:', postErr);
                    }
                    
                    // 无论postMessage是否成功，都延迟后重定向到index.html
                    // 这样可以确保即使postMessage失败，也能通过index.html处理
                    setTimeout(function() {
                        try {
                            // 重定向到index.html，让index.html处理完整的授权流程
                            // index.html会检查URL参数，如果有code则处理
                            var redirectUrl = window.location.origin + '/index.html?' + window.location.search.substring(1);
                            window.location.href = redirectUrl;
                        } catch (redirectErr) {
                            console.error('重定向失败:', redirectErr);
                            document.body.innerHTML = '<div class="message"><p style="color: #ff6b6b;">❌ 处理失败，请手动关闭窗口。</p></div>';
                        }
                    }, 500); // 给postMessage一些时间
                } 
                // 方案2：如果没有父窗口（直接访问），直接重定向到index.html处理
                else {
                    console.log('未检测到父窗口，重定向到index.html处理回调');
                    var redirectUrl = window.location.origin + '/index.html?' + window.location.search.substring(1);
                    window.location.href = redirectUrl;
                }
            } catch (err) {
                console.error('Zalo回调处理错误:', err);
                // 如果出错，尝试重定向到index.html
                try {
                    var redirectUrl = window.location.origin + '/index.html?' + window.location.search.substring(1);
                    window.location.href = redirectUrl;
                } catch (redirectErr) {
                    document.body.innerHTML = '<div class="message"><p style="color: #ff6b6b;">❌ 处理失败，请手动关闭窗口。</p></div>';
                }
            }
        })();
    </script>
</body>
</html>